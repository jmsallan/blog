---
title: Clustering Spatial Data with DBSCAN
author: Jose M Sallan
date: '2026-01-11'
slug: []
categories:
  - R
  - data analysis
tags:
  - Barcelona
  - clustering
  - nightlife
meta_img: images/image.png
description: Description for the page
---



<p>In [a previous post]<a href="https://jmsallan.netlify.app/blog/implementation-of-dbscan-clustering-in-r/" class="uri">https://jmsallan.netlify.app/blog/implementation-of-dbscan-clustering-in-r/</a>), I introduced a clustering technique called <strong>discrete-based spatial clustering and applications with noise (DBSCAN)</strong>. This clustering technique is density-based, detecting sets of elements located in a region of high density. This approach is different from traditional clustering techniques like k-means or hierarchical clustering. These techniques identify sets where the distance within elements is smaller than distance between elements of other clusters.</p>
<p>DBSCAN is a suitable technique for spatial analysis. While in distance-based techniques like k-means the regions defined by clusters tend to be circular, DBSCAN clusters can have any shape.</p>
<p>In this post, I will extend the DBSCAN workflow of previous posts in two directions:</p>
<ul>
<li>How to identify an adequate value of the distance between core points <code>eps</code> using the plot of <strong>k-nearest neighbor distances</strong>.</li>
<li>How to use the functions of the <code>dbscan</code> package with spatial objects, using the distance matrix instead of geographical coordinates.</li>
</ul>
<pre class="r"><code>library(tidyverse) # data handling and plotting
library(sf) # geocomputation
library(BAdatasetsSpatial) # BCN map
library(dbscan) # DBSCAN clustering
library(RColorBrewer) # color palettes</code></pre>
<p>I will be using the dataset of nightlife Barcelona venues <code>nightlife_2024</code>, and its transformation as spatial object <code>nightlife_2024_sf</code>. To plot the final result, I will use the <code>bcn_neigh</code> Barcelona map of neighborhoods.</p>
<pre class="r"><code>bcn_neigh &lt;- BCNNeigh |&gt;
  select(c_barri, n_barri, c_distri, n_distri)</code></pre>
<pre class="r"><code>nightlife_2024 &lt;- data_2024 |&gt;
  select(nom_local, latitud, longitud, nom_barri, codi_barri)

nightlife_2024_sf &lt;- nightlife_2024 |&gt;
  st_as_sf(coords = c(&quot;longitud&quot;, &quot;latitud&quot;), crs = 4326, remove = FALSE)</code></pre>
<p>A common approach to cluster spatial data is use longitude and latitude directly, as they represent approximately the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> coordinates of each point. But in DBSCAN the <code>eps</code> parameter is expressed in distance units, so we cannot use longitude and latitude directly. <code>dbscan::dbscan()</code> allows using a distance matrix rather than a set of coordinates. To obtain this distance, I have used the <code>sf::st_distance()</code> function and transformed the result to a distance object with <code>as.dist()</code>.</p>
<pre class="r"><code>nl_distances &lt;- st_distance(nightlife_2024_sf) |&gt;
  as.dist()</code></pre>
<p>As it is two-dimensional dataset, I will use the standard value <code>minPts = 3</code>. We need, though, to establish an adequate value of distance between core points <code>eps</code>. To do so, I have used the k-nearest neighbor distances plot. Obtained with <code>dbscan::kNNdistplot()</code>, it represents the distance between each element and its k-th distant neighbor. As <code>minPts</code> includes the point from we calculate distances, we need to set <code>k = minPts - 1</code>.</p>
<pre class="r"><code>kNNdistplot(nl_distances, k = 2)
abline(a = 400, b = 0, col = &quot;red&quot;, lty = 2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The choice of <code>eps</code> is the elbow point of this plot. In this case, I have chose <code>eps = 450</code>. The results of the clustering are stored in <code>nl_dbscan</code>.</p>
<pre class="r"><code>nl_dbscan &lt;- dbscan(nl_distances, eps = 450, minPts = 3)
table(nl_dbscan$cluster)</code></pre>
<pre><code>## 
##  0  1  2  3  4  5  6  7  8 
## 13 13 85 96  3  4 13  4 11</code></pre>
<p>The algorithm returns eight different clusters and 13 noise points, not assigned to any cluster. These noise points are assigned to the <code>0</code> cluster.</p>
<pre class="r"><code>augment(nl_dbscan, nightlife_2024_sf) |&gt;
  filter(noise) |&gt;
  st_drop_geometry() |&gt;
  select(nom_local, .cluster, noise)</code></pre>
<pre><code>## # A tibble: 13 × 3
##    nom_local                 .cluster noise
##    &lt;chr&gt;                     &lt;fct&gt;    &lt;lgl&gt;
##  1 NUMANCIA 12 NIGHT CLUB    0        TRUE 
##  2 LUXOR SHISHA CLUB         0        TRUE 
##  3 SAFARI DISCO CLUB         0        TRUE 
##  4 MAGBA BRUNCH SISHA LOUNGE 0        TRUE 
##  5 LUXIUM LOUNGE CLUB        0        TRUE 
##  6 LOUNGE BAR CHILL OUT      0        TRUE 
##  7 RAKATÁ                    0        TRUE 
##  8 LA CALLE                  0        TRUE 
##  9 CLUB EL NIDO ROJO         0        TRUE 
## 10 DISCOTECA PEDRALBES       0        TRUE 
## 11 LOS TILOS                 0        TRUE 
## 12 DOWNTOWN                  0        TRUE 
## 13 DOWNTOWN                  0        TRUE</code></pre>
<p>To obtain a preliminary plot of the clusters, I use <code>broom::augment()</code> to assign points to clusters.</p>
<pre class="r"><code>augment(nl_dbscan, nightlife_2024) |&gt;
  ggplot(aes(longitud, latitud, color = .cluster)) +
  geom_point() +   
  theme_minimal(base_size = 14)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Finally, I can place clusters over a map.I need to take into account two issues:</p>
<ul>
<li>We cannot use <code>broom::augment()</code> with spatial objects, so I need to assign clusters with <code>dplyr::mutate()</code>.</li>
<li>I have created a color palette <code>col_clust</code> using the divergent Brewer palette <code>Paired</code>, setting in grey the noise points.</li>
</ul>
<pre class="r"><code>col_clust &lt;- c(&quot;#A0A0A0&quot;, brewer.pal(8, &quot;Paired&quot;))

nl_dbscan_sf &lt;- nightlife_2024_sf |&gt;
  mutate(cluster = as.factor(nl_dbscan$cluster))

ggplot(bcn_neigh) +
  geom_sf(fill = &quot;white&quot;) +
  geom_sf(data = nl_dbscan_sf, aes(color = cluster)) +
  scale_color_manual(values = col_clust) +
  theme_void() +
  theme(legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Here is the result of the DBSCAN clustering:</p>
<ul>
<li>Two large clusters: cluster <code>2</code> corresponds with the city downtown, and <code>3</code> with the more residential districts of Gràcia and Sant Gervasi. - Three medium-size clusters. Cluster <code>6</code> is located at the northern neighborhoods, mainly El Guinardó. Cluster <code>8</code> includes venues around Poblenou. Cluster <code>1</code> includes venues at Sants and Badal.</li>
<li>Three small clusters. located at Eixample (cluster <code>4</code>), Vila Olímpica (cluster <code>7') and Horta (cluster</code>5`).</li>
</ul>
<div id="references" class="section level2">
<h2>References</h2>
<ul>
<li>Ester, Martin, Hans-Peter Kriegel, Jörg Sander, Xiaowei Xu, et al. (1996). A Density-Based Algorithm for Discovering Clusters in Large Spatial Databases with Noise. In <em>Proceedings of 2nd International Conference on Knowledge Discovery and Data Mining (KDD-96)</em>, 226–231. <a href="https://dl.acm.org/doi/10.5555/3001460.3001507" class="uri">https://dl.acm.org/doi/10.5555/3001460.3001507</a></li>
<li>Hahsler, M., Piekenbrock, M., &amp; Doran, D. (2019). dbscan: Fast density-based clustering with R. <em>Journal of Statistical Software</em>, 91, 1-30.<a href="https://doi.org/10.18637/jss.v091.i01" class="uri">https://doi.org/10.18637/jss.v091.i01</a></li>
</ul>
</div>
<div id="session-info" class="section level2">
<h2>Session Info</h2>
<pre><code>## R version 4.5.2 (2025-10-31)
## Platform: x86_64-pc-linux-gnu
## Running under: Linux Mint 21.1
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0  LAPACK version 3.10.0
## 
## locale:
##  [1] LC_CTYPE=es_ES.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=es_ES.UTF-8        LC_COLLATE=es_ES.UTF-8    
##  [5] LC_MONETARY=es_ES.UTF-8    LC_MESSAGES=es_ES.UTF-8   
##  [7] LC_PAPER=es_ES.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=es_ES.UTF-8 LC_IDENTIFICATION=C       
## 
## time zone: Europe/Madrid
## tzcode source: system (glibc)
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] RColorBrewer_1.1-3      dbscan_1.2.3            BAdatasetsSpatial_0.1.0
##  [4] sf_1.0-20               lubridate_1.9.4         forcats_1.0.1          
##  [7] stringr_1.6.0           dplyr_1.1.4             purrr_1.2.0            
## [10] readr_2.1.5             tidyr_1.3.1             tibble_3.3.0           
## [13] ggplot2_4.0.0           tidyverse_2.0.0        
## 
## loaded via a namespace (and not attached):
##  [1] s2_1.1.7           utf8_1.2.4         sass_0.4.10        generics_0.1.3    
##  [5] class_7.3-23       KernSmooth_2.23-26 blogdown_1.21      stringi_1.8.7     
##  [9] hms_1.1.4          digest_0.6.37      magrittr_2.0.4     evaluate_1.0.3    
## [13] grid_4.5.2         timechange_0.3.0   bookdown_0.43      fastmap_1.2.0     
## [17] jsonlite_2.0.0     e1071_1.7-16       DBI_1.2.3          scales_1.4.0      
## [21] jquerylib_0.1.4    cli_3.6.4          rlang_1.1.6        units_0.8-7       
## [25] withr_3.0.2        cachem_1.1.0       yaml_2.3.10        tools_4.5.2       
## [29] tzdb_0.5.0         vctrs_0.6.5        R6_2.6.1           proxy_0.4-27      
## [33] lifecycle_1.0.4    classInt_0.4-11    pkgconfig_2.0.3    pillar_1.11.1     
## [37] bslib_0.9.0        gtable_0.3.6       Rcpp_1.1.0         glue_1.8.0        
## [41] xfun_0.52          tidyselect_1.2.1   rstudioapi_0.17.1  knitr_1.50        
## [45] farver_2.1.2       htmltools_0.5.8.1  labeling_0.4.3     rmarkdown_2.29    
## [49] wk_0.9.4           compiler_4.5.2     S7_0.2.0</code></pre>
</div>
